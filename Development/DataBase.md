# 数据库

## 事务

### 事务是什么，事务的特性有哪些

事务是数据库操作的最小单位，以 BEGIN TRANSACTION 开始，ROLLBACK/COMMIT 结束。
事务的特性简写成 ACID，分别是

1. Atomically 原子性，事务是数据库操作的最小单位。事务要么全部执行完并提交，要么都不执行。
2. Consistently 一致性，事务开始前和事务结束后数据库是一致的，比如一笔转账事务结束后，转出和转入账户需要的修改都应执行完毕。
3. Isolation 隔离性，事务之间是隔离的，并发执行的事务互不干扰。事务提交前的修改对其他事务不可见。
4. Durability 持久性。事务提交后对数据库的修改是永久的。

### 事务干扰的表现有哪些

1. 脏读， 读其他事务未提交的数据
2. 不可重复读。 同一事务中的两次读得到的结果不一样
3. 幻读。 事务两次查询的结果不一样
4. 修改丢失。 事务进行的修改被其他事务提交的修改覆盖。

### 数据库的隔离级别有哪些，是如何实现的

1. 读未提交。未进行隔离
2. 读提交。  
   通过进行二级封锁，在事务读之前加 S 锁，读之后释放，防止读过程中其他事务进行写入。
3. 可重复读  
   通过进行三级封锁，在事务读之前加 S 锁，事务结束之后才能释放，防止两次读之间有其他事务写入。
4. 串行化  
   对事务进行强制串行化执行。

### 数据库有哪些锁

1. 读锁，共享锁 Share S 锁
2. 写锁，排它锁 Exclusive X 锁
3. 意向锁 IS 和 IX 锁  
   在事务要对某一行加 S 或 X 锁时，需要对整个表添加 IS 或 IX 锁。  
   作用是防止某事务要对整个表加锁时，要对每一行确认是否有锁。

### 数据库如何进行并发控制

数据库使用多版本并发控制 Muti-Version Concurrency Control MVCC 进行并发事务的控制。
主要方法是维护

- Read-View，
- 隐藏列 db-trx-id，db-roll-ptr,
- UndoLog

Read-View 包括

- 当前事务 id: creator-id;
- 当前并发事务 id 表 m_ids;
- 下一个未执行事务 id max-trx-id;
- 当前并发事务中最小的 id min-trx-id

通过一定策略在读时对 UndoLog 中搜索事务可读的数据。

## 数据库操作和优化

### 数据库删除操作有哪些

1. drop 操作删除表和附带的索引，同时不会触发触发器，无法回滚。
2. delete 删除表中的元素
3. truncate 删除表中所有数据（实质是 drop 后创建一个新的表），同时不会触发触发器，无法回滚。

### 索引的在哪些情况下失效

1. 以'%'开头的 like 语句
2. or 的两边没有同时使用索引
3. 多列索引时必须满足最左匹配原则（e.g.索引是(e1,e2,e3)，则查询应是 e1 或 e1,e2 或 e1,e2,e3）
4. 发生隐式转化，比如 varchar 不加引号时有时会转化成 int

### MySQL 的数据存储系统有哪些，有什么区别

1. InnoDB 支持事务，MyISAM 不支持
2. InnoDB 支持外键，MyISAM 不支持
3. InnoDB 发生崩溃时数据更有可能保持完整和正确
4. InnoDB 支持行级锁，MyISAM 只支持表级锁
5. MyISAM 支持空间数据索引和表压缩
6. InnoDB 支持在线热备份

### 数据库优化有哪些方法

1. SQL 语句的优化
2. 索引优化
3. 数据库表结构优化
4. 硬件优化
5. 操作系统优化

### 解释主从复制，有什么用，原理是什么

主从复制是将数据从主服务器复制全部或一部分到从服务器中的做法。  
主要目的是读写分离，主服务器负责写，从服务器负责读，这样可以有效的增加读写性能，增加并发能力，减少锁冲突。同时可以增加数据备份和冗余。  
实现原理如下：

1. 主服务器修改时记录 Binary Log
2. 从服务器从主服务器复制 Log 到本地的 Relay Log
3. 从服务器在本地复制主服务器的操作

### 关系型数据库和非关系型数据库的区别？

- 前者高度组织化结构化数据；后者存储的数据结构不固定更加灵活，可以减少一些空间和时间的开销
- 后者更加容易水平扩展
- 前者支持结构化查询语言，支持复杂的查询功能和表关联。后者只能进行简单的查询
- 前者支持事务，具有 ACID 特性。后者则是 BASE，最终一致性
